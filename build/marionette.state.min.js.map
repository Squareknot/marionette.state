{"version":3,"sources":["marionette.state.min.js","/source/marionette.state.js"],"names":["_classCallCheck","instance","Constructor","TypeError","_createClass","defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","key","protoProps","staticProps","prototype","global","factory","exports","module","require","define","amd","Marionette","State","_","Backbone","Mn","this","syncBinding","entity","event","handlers","changeAttrMatch","collectionMatch","Collection","match","collectionEventMatcher","modelMatch","Model","state","modelEventMatcher","changeValue","get","isFunction","call","handlerKeys","split","spaceMatcher","handlerKey","sync","bindings","eventStr","events","syncEntityEvents","syncing","Syncing","_when","_now","hasChanged","model","_model","keys","changed","hasAnyChanged","_len2","arguments","attrs","Array","_key2","chain","intersection","size","value","extend","modelClass","undefined","defaultState","componentEvents","_component","_initialState","constructor","_ref","initialState","component","preventDestroy","_initState","bindComponent","__super__","apply","reset","_proxyModelEvents","getModel","getInitialState","clone","attr","set","val","options","resetAttrs","changedAttributes","previousAttributes","_len","_key","concat","_ref2","bindEntityEvents","_bindLifecycle","unbindComponent","unbindEntityEvents","_unbindLifecycle","_boundDestroy","destroy","bind","listenTo","stopListening","entityEvents","other","trigger","state_functions","off","handler","on","stop","index"],"mappings":"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","file":"marionette.state.min.js","sourcesContent":[null,"(function (global, factory) {\n  typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory(require('underscore'), require('backbone'), require('backbone.marionette')) :\n  typeof define === 'function' && define.amd ? define(['underscore', 'backbone', 'backbone.marionette'], factory) :\n  global.Marionette.State = factory(global._, global.Backbone, global.Mn)\n}(this, function (_, Backbone, Mn) { 'use strict';\n\n  const State = Mn.Object.extend({\n\n    // State model class to instantiate\n    modelClass: undefined,\n\n    // Default state attributes hash\n    defaultState: undefined,\n\n    // Events from my component\n    componentEvents: undefined,\n\n    // State model instance\n    _model: undefined,\n\n    // My component, facilitating lifecycle management and event bindings\n    _component: undefined,\n\n    // Initial state attributes hash after 'initialState' option and defaults are applied\n    _initialState: undefined,\n\n    // options {\n    //   initialState: {object} Attributes that will override `defaultState`.  The result of\n    //     defaultState + initialState is the state reverted to by `#reset`.\n    //   component: {Mn object} Object to which to bind `componentEvents` and also lifecycle;\n    //     i.e., when `component` fires 'destroy', then destroy myself.\n    //   preventDestroy: {boolean} If true, then this will not destroy on `component` destroy.\n    // }\n    constructor({ initialState, component, preventDestroy }={}) {\n      // State model class is either passed in, on the class, or a standard Backbone model\n      this.modelClass = this.modelClass || Backbone.Model;\n\n      // Initialize state\n      this._initState(initialState);\n\n      if (component) {\n        this.bindComponent(component, { preventDestroy });\n      }\n\n      State.__super__.constructor.apply(this, arguments);\n    },\n\n    // Initialize model with attrs or reset it, destructively, to conform to attrs.\n    _initState(attrs) {\n      // Set initial state.\n      this._initialState = _.extend({}, this.defaultState, attrs);\n\n      if (this._model) {\n        // Reset existing model with initial state.\n        this.reset();\n      } else {\n        // Create new model with initial state.\n        /* eslint-disable new-cap */\n        this._model = new this.modelClass(this._initialState);\n        this._proxyModelEvents(this._model);\n      }\n    },\n\n    // Return the state model.\n    getModel() {\n      return this._model;\n    },\n\n    // Returns the initiate state, which is reverted to by reset()\n    getInitialState() {\n      return _.clone(this._initialState);\n    },\n\n    // Proxy to model get().\n    get(attr) {\n      return this._model.get(attr);\n    },\n\n    // Proxy to model set().\n    set(key, val, options) {\n      this._model.set(key, val, options);\n      return this;\n    },\n\n    // Return state to its initial value.\n    // If `attrs` is provided, they will override initial values for a \"partial\" reset.\n    // Initial state will remain unchanged regardless of override attributes.\n    reset(attrs, options) {\n      var resetAttrs = _.extend({}, this._initialState, attrs);\n      this._model.set(resetAttrs, options);\n      return this;\n    },\n\n    // Proxy to model changedAttributes().\n    changedAttributes() {\n      return this._model.changedAttributes();\n    },\n\n    // Proxy to model previousAttributes().\n    previousAttributes() {\n      return this._model.previousAttributes();\n    },\n\n    // Whether state has changed since the last `set()`\n    hasChanged() {\n      return State.hasChanged(this);\n    },\n\n    // Whether any of the passed attributes were changed during the last modification\n    hasAnyChanged(...attrs) {\n      return State.hasAnyChanged(this, ...attrs);\n    },\n\n    // Bind `componentEvents` to `component` and cascade destroy to self when component fires\n    // 'destroy'.  To prevent self-destroy behavior, pass `preventDestroy: true` as an option.\n    bindComponent(component, { preventDestroy }={}) {\n      this.bindEntityEvents(component, this.componentEvents);\n      if (!preventDestroy) {\n        this._bindLifecycle(component);\n      }\n    },\n\n    // Unbind `componentEvents` from `component` and stop listening to component 'destroy' event.\n    unbindComponent(component) {\n      this.unbindEntityEvents(component, this.componentEvents);\n      this._unbindLifecycle(component);\n    },\n\n    // When `component` fires \"destroy\" event, this State will also destroy.\n    _bindLifecycle(component) {\n      if (!this._boundDestroy) {\n        this._boundDestroy = this.destroy.bind(this);\n      }\n      this.listenTo(component, 'destroy', this._boundDestroy);\n      return this;\n    },\n\n    // Stop listening to `component` \"destroy\" event.\n    _unbindLifecycle(component) {\n      this.stopListening(component, 'destroy', this._boundDestroy);\n      return this;\n    },\n\n    // Proxy to StateFunctions#syncEntityEvents.\n    syncEntityEvents(entity, entityEvents, event) {\n      State.syncEntityEvents(this, entity, entityEvents, event);\n      return this;\n    },\n\n    // Convert model events to state events\n    _proxyModelEvents: function (other) {\n      this.listenTo(other, 'all', function () {\n        if (arguments.length > 1 && arguments[1] === this._model) {\n          // Replace model argument with State\n          arguments[1] = this;\n        }\n        this.trigger.apply(this, arguments);\n      });\n    }\n  });\n\n  var state = State;\n\n  var state_functions = {\n    get syncEntityEvents () { return syncEntityEvents; },\n    get hasChanged () { return hasChanged; },\n    get hasAnyChanged () { return hasAnyChanged; }\n  };\n\n  var modelEventMatcher = /^(?:all|change|change:(.+))$/;\n  var collectionEventMatcher = /^(?:all|reset)$/;\n  var spaceMatcher = /\\s+/;\n\n  // Sync individual event binding 'event1' => 'handler1 handler2'.\n  function syncBinding(target, entity, event, handlers) {\n    var changeAttrMatch;\n    var collectionMatch =\n      entity instanceof Backbone.Collection &&\n      event.match(collectionEventMatcher);\n    var modelMatch =\n      (entity instanceof Backbone.Model || entity instanceof state) &&\n      (changeAttrMatch = event.match(modelEventMatcher));\n    if (!collectionMatch && !modelMatch) {\n      return;\n    }\n\n    var changeValue = changeAttrMatch && entity.get(changeAttrMatch[1]);\n    if (_.isFunction(handlers)) {\n      handlers.call(target, entity, changeValue);\n    } else {\n      var handlerKeys = handlers.split(spaceMatcher);\n      for (var i = 0; i < handlerKeys.length; i++) {\n        var handlerKey = handlerKeys[i];\n        target[handlerKey](entity, changeValue);\n      }\n    }\n  }\n\n  // Sync bindings hash { 'event1 event 2': 'handler1 handler2' }.\n  function sync(target, entity, bindings) {\n    for (var eventStr in bindings) {\n      var handlers = bindings[eventStr];\n      var events = eventStr.split(spaceMatcher);\n      for (var i = 0; i < events.length; i++) {\n        var event = events[i];\n        syncBinding(target, entity, event, handlers);\n      }\n    }\n  }\n\n  // A stoppable handle on the syncing listener\n  class Syncing {\n\n    constructor(target, entity, bindings) {\n      this.target = target;\n      this.entity = entity;\n      this.bindings = bindings;\n    }\n\n    stop() {\n      Mn.unbindEntityEvents(this.target, this.entity, this.bindings);\n      this.target.off(this.event, this.handler);\n      this.event = this.handler = null;\n    }\n\n    _when(event) {\n      Mn.bindEntityEvents(this.target, this.entity, this.bindings);\n      this.event = event;\n      this.handler = _.bind(sync, this, this.target, this.entity, this.bindings);\n      this.target\n        .on(this.event, this.handler)\n        .on('destroy', _.bind(this.stop, this));\n    }\n\n    _now() {\n      Mn.bindEntityEvents(this.target, this.entity, this.bindings);\n      sync(this.target, this.entity, this.bindings);\n    }\n  }\n\n  // Binds events handlers located on target to an entity using Marionette.bindEntityEvents, and\n  // also \"syncs\" initial state either immediately or whenever target fires a specific event.\n  //\n  // Initial state is synced by calling certain handlers at a precise moment.  Only the following\n  // entity events will sync their handlers: 'all', 'change', 'change:attr', and 'reset'.\n  //\n  // Returns a Syncing instance.  While syncing handlers are unbound on target destroy, the syncing\n  // instance has a single public method stop() for ceasing syncing on target events early.\n  function syncEntityEvents(target, entity, bindings, event) {\n    var syncing = new Syncing(target, entity, bindings);\n    if (event) {\n      syncing._when(event);\n    } else {\n      syncing._now();\n    }\n    return syncing;\n  }\n\n  // Whether model has changed since the last `set()`\n  function hasChanged(model) {\n    // Support Marionette.State or Backbone.Model performantly.\n    if (model._model) { model = model._model; }\n    return !!_.keys(model.changed).length;\n  }\n\n  // Determine if any of the passed attributes were changed during the last modification of `model`.\n  function hasAnyChanged(model, ...attrs) {\n    // Support Marionette.State or Backbone.Model performantly.\n    if (model._model) { model = model._model; }\n    return !!_.chain(model.changed)\n      .keys()\n      .intersection(attrs)\n      .size()\n      .value();\n  }\n\n  _.extend(state, state_functions);\n\n  var index = state;\n\n  return index;\n\n}));\n"],"sourceRoot":"/source/"}