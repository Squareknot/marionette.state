!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("underscore"),require("backbone"),require("backbone.marionette")):"function"==typeof define&&define.amd?define(["underscore","backbone","backbone.marionette"],e):t.Marionette.State=e(t._,t.Backbone,t.Mn)}(this,function(t,e,n){"use strict";function i(e,n,i,s){var o=s?n.get(s):void 0;if(t.isFunction(i))i.call(e,n,o);else{var r=i.split(u);t.each(r,function(t){e[t](n,o)})}}function s(t,n,s,o){var r;if("change"===s||"all"===s||n instanceof e.Collection&&"reset"===s)i(t,n,o);else if((n instanceof e.Model||n instanceof v)&&(r=s.match(l))){var a=r[1];i(t,n,o,a)}}function o(e,n,i,o){t.each(i,function(t){s(e,n,t,o)})}function r(e,n,i){t.each(i,function(t,i){var s=i.split(u);o(e,n,s,t)})}function a(t,e,n){this.target=t,this.entity=e,this.bindings=n}function h(t,e,i,s){n.bindEntityEvents(t,e,i);var o=new a(t,e,i);s?o.when(s):o.now()}function c(e,i,s){n.unbindEntityEvents(e,i,s),e.__syncingEntityEvents&&t.each(e.__syncingEntityEvents,function(t){e.stopListening(t.eventObj,t.event,t.handler)})}var l=/^change:(.+)/,u=/\s+/;a.prototype.when=function(t,e){var n=this;return e||(e=t,t=this.target),this.eventObj=t,this.event=e,this.handler=function(){r(n.target,n.entity,n.bindings)},this.target.__syncingEntityEvents=this.target.__syncingEntityEvents||[],this.target.__syncingEntityEvents.push(this),this.target.listenTo(this.eventObj,this.event,this.handler),this},a.prototype.now=function(){return r(this.target,this.entity,this.bindings),this};var d=n.Object.extend({modelClass:void 0,defaultState:void 0,componentEvents:void 0,_model:void 0,_component:void 0,_initialState:void 0,constructor:function(t){t=t||{},t.component&&this.setComponent(t.component),this.modelClass=t.modelClass||this.modelClass||e.Model,this.initState(t.initialState),d.__super__.constructor.apply(this,arguments)},initState:function(e,n){this._initialState=t.extend({},this.defaultState,e),this._model?this.reset(null,n):(this._model=new this.modelClass(this._initialState),this._proxyEvents(this._model))},setComponent:function(t){this.stopListening(this._component,"destroy"),this.componentEvents&&this.unbindEntityEvents(this._component,this.componentEvents),this._component=t,this.listenToOnce(this._component,"destroy",this.destroy),this.componentEvents&&this.bindEntityEvents(this._component,this.componentEvents)},getInitialState:function(){return t.clone(this._initialState)},getComponent:function(){return this._component},getModel:function(){return this._model},set:function(){if(!this._model)throw new n.Error("Initialize state first.");this._model.set.apply(this._model,arguments)},get:function(){if(!this._model)throw new n.Error("Initialize state first.");return this._model.get.apply(this._model,arguments)},reset:function(e,n){var i=t.extend({},this._initialState,e);this._model.set(i,n)},getChanged:function(){return this._model.changedAttributes()},getPrevious:function(){return this._model.previousAttributes()},hasAnyChanged:function(){for(var e=arguments.length,n=Array(e),i=0;e>i;i++)n[i]=arguments[i];return!!t.chain(this._model.changed).keys().intersection(n).size().value()},syncEntityEvents:function(t,e,n){return h(this,t,e,n)},_proxyEvents:function(t){this.listenTo(t,"all",function(){arguments.length>1&&arguments[1]===this._model&&(arguments[1]=this),this.trigger.apply(this,arguments)}.bind(this))}}),v=d,f=n.Behavior.extend({initialize:function(e){if(e=e||{},!e.stateClass)throw new n.Error("Must provide 'stateClass'.");var i=e.stateClass,s=e.syncEvent||"render",o=t.extend({initialState:e.initialState,component:this.view},e.stateOptions,this._mapOptions(e.mapOptions)),r=new i(o);if(this.view.stateModel)throw new Error("View already contains a stateModel attribute.");this.view.stateModel=r.getModel(),this.view.stateEvents&&h(this.view,this.view.stateModel,this.view.stateEvents,s),e.serialize&&this._wrapSerializeData()},_mapOptions:function(e){return e?t.object(t.map(e,this._mapOption,this)):{}},_mapOption:function(e,i){var s;if(e===!0)s=this.view.options[i];else if(t.isString(e))s=t.reduce(e.split("."),function(t,e){return t[e]},this.view.options);else{if(!t.isFunction(e))throw new n.Error("Invalid mapOption value. Expecting true, String, or Function.");s=e.call(this.view,this.view.options)}return[i,s]},_wrapSerializeData:function(){var e=this,i=this.view.serializeData,s=this.view.state;this.view.serializeData=function(){var o=i.call(e),r=t.clone(s.attributes);if(t.isUndefined(o.state))o.state=r;else{if(!t.isObject(o.state))throw new n.Error("'state' already defined and not extensible.");e._mergeAttrs(o.state,r)}return o}},_mergeAttrs:function(e,i){for(var s in i){if(!t.isUndefined(e[s]))throw new n.Error("Attribute '"+s+"' already defined.");e[s]=i[s]}}}),p=f;v.Behavior=p,v.syncEntityEvents=h,v.stopSyncingEntityEvents=c;var m=v;return m});
//# sourceMappingURL=marionette.state.min.js.map